@using ApBox.Plugins
@using System.ComponentModel.DataAnnotations

<Container Fluid>
    <Row Margin="Margin.Is3.FromBottom">
        <Column>
            <Heading Size="HeadingSize.Is3" ElementId="feedback-title">Default Feedback Configuration</Heading>
            <Paragraph TextColor="TextColor.Muted">Configure default feedback patterns for successful and failed card reads</Paragraph>
        </Column>
    </Row>

    <Row>
        <Column ColumnSize="ColumnSize.Is6.OnTablet">
            <Card>
                <CardHeader Background="Background.Success" TextColor="TextColor.White">
                    <CardTitle Size="6" Margin="Margin.Is0.FromBottom">
                        <Icon Name="IconName.Check" Margin="Margin.Is2.FromEnd" />Success Feedback
                    </CardTitle>
                </CardHeader>
                <CardBody>
                    <Validations @ref="_successValidations" Model="_successForm" ValidateOnLoad="false">
                        <Validation>
                            <Field>
                                <FieldLabel>LED Color</FieldLabel>
                                <Select @bind-SelectedValue="_successForm.LedColor" ElementId="success-led-color">
                                    <SelectItem Value="LedColor.Green">Green</SelectItem>
                                    <SelectItem Value="LedColor.Red">Red</SelectItem>
                                    <SelectItem Value="LedColor.Amber">Amber</SelectItem>
                                    <SelectItem Value="LedColor.Blue">Blue</SelectItem>
                                </Select>
                            </Field>
                        </Validation>
                        <Validation>
                            <Field>
                                <FieldLabel>LED Duration (seconds)</FieldLabel>
                                <NumericEdit @bind-Value="_successForm.LedDurationSeconds" Min="1" Max="10" Step="1" ElementId="success-led-duration">
                                    <Feedback>
                                        <ValidationError />
                                    </Feedback>
                                </NumericEdit>
                            </Field>
                        </Validation>
                        <Validation>
                            <Field>
                                <FieldLabel>Beep Count</FieldLabel>
                                <NumericEdit @bind-Value="_successForm.BeepCount" Min="0" Max="10" ElementId="success-beep-count">
                                    <Feedback>
                                        <ValidationError />
                                    </Feedback>
                                </NumericEdit>
                            </Field>
                        </Validation>
                        <Validation>
                            <Field>
                                <FieldLabel>Display Message</FieldLabel>
                                <TextEdit @bind-Text="_successForm.DisplayMessage" MaxLength="16" ElementId="success-display-message">
                                    <Feedback>
                                        <ValidationError />
                                    </Feedback>
                                </TextEdit>
                                <FieldHelp>Maximum 16 characters for OSDP display (optional)</FieldHelp>
                            </Field>
                        </Validation>
                    </Validations>
                </CardBody>
            </Card>
        </Column>

        <Column ColumnSize="ColumnSize.Is6.OnTablet">
            <Card>
                <CardHeader Background="Background.Danger" TextColor="TextColor.White">
                    <CardTitle Size="6" Margin="Margin.Is0.FromBottom">
                        <Icon Name="IconName.Times" Margin="Margin.Is2.FromEnd" />Failure Feedback
                    </CardTitle>
                </CardHeader>
                <CardBody>
                    <Validations @ref="_failureValidations" Model="_failureForm" ValidateOnLoad="false">
                        <Validation>
                            <Field>
                                <FieldLabel>LED Color</FieldLabel>
                                <Select @bind-SelectedValue="_failureForm.LedColor" ElementId="failure-led-color">
                                    <SelectItem Value="LedColor.Green">Green</SelectItem>
                                    <SelectItem Value="LedColor.Red">Red</SelectItem>
                                    <SelectItem Value="LedColor.Amber">Amber</SelectItem>
                                    <SelectItem Value="LedColor.Blue">Blue</SelectItem>
                                </Select>
                            </Field>
                        </Validation>
                        <Validation>
                            <Field>
                                <FieldLabel>LED Duration (seconds)</FieldLabel>
                                <NumericEdit @bind-Value="_failureForm.LedDurationSeconds" Min="1" Max="10" Step="1" ElementId="failure-led-duration">
                                    <Feedback>
                                        <ValidationError />
                                    </Feedback>
                                </NumericEdit>
                            </Field>
                        </Validation>
                        <Validation>
                            <Field>
                                <FieldLabel>Beep Count</FieldLabel>
                                <NumericEdit @bind-Value="_failureForm.BeepCount" Min="0" Max="10" ElementId="failure-beep-count">
                                    <Feedback>
                                        <ValidationError />
                                    </Feedback>
                                </NumericEdit>
                            </Field>
                        </Validation>
                        <Validation>
                            <Field>
                                <FieldLabel>Display Message</FieldLabel>
                                <TextEdit @bind-Text="_failureForm.DisplayMessage" MaxLength="16" ElementId="failure-display-message">
                                    <Feedback>
                                        <ValidationError />
                                    </Feedback>
                                </TextEdit>
                                <FieldHelp>Maximum 16 characters for OSDP display (optional)</FieldHelp>
                            </Field>
                        </Validation>
                    </Validations>
                </CardBody>
            </Card>
        </Column>
    </Row>

    <!-- Global Idle State Configuration -->
    <Row Margin="Margin.Is4.FromTop">
        <Column>
            <Card>
                <CardHeader>
                    <CardTitle Size="6" Margin="Margin.Is0.FromBottom">
                        <Icon Name="IconName.Moon" Margin="Margin.Is2.FromEnd" />Idle State LED Configuration
                    </CardTitle>
                </CardHeader>
                <CardBody>
                    <Paragraph TextColor="TextColor.Muted" Margin="Margin.Is3.FromBottom">
                        Configure LED behavior when no card read activity is occurring
                    </Paragraph>
                    <Row>
                        <Column ColumnSize="ColumnSize.Is6.OnTablet">
                            <Validations @ref="_idleValidations" Model="_idleForm" ValidateOnLoad="false">
                                <Validation>
                                    <Field>
                                        <FieldLabel>Permanent LED Color</FieldLabel>
                                        <Select @bind-SelectedValue="_idleForm.PermanentLedColor" ElementId="idle-permanent-led-color">
                                            <SelectItem Value="LedColor.Green">Green</SelectItem>
                                            <SelectItem Value="LedColor.Red">Red</SelectItem>
                                            <SelectItem Value="LedColor.Amber">Amber</SelectItem>
                                            <SelectItem Value="LedColor.Blue">Blue</SelectItem>
                                            <SelectItem Value="@((LedColor?)null)">Off</SelectItem>
                                        </Select>
                                        <FieldHelp>LED color that stays on when reader is idle</FieldHelp>
                                    </Field>
                                </Validation>
                                <Validation>
                                    <Field>
                                        <FieldLabel>Heartbeat Flash Color</FieldLabel>
                                        <Select @bind-SelectedValue="_idleForm.HeartbeatFlashColor" ElementId="idle-heartbeat-flash-color">
                                            <SelectItem Value="LedColor.Green">Green</SelectItem>
                                            <SelectItem Value="LedColor.Red">Red</SelectItem>
                                            <SelectItem Value="LedColor.Amber">Amber</SelectItem>
                                            <SelectItem Value="LedColor.Blue">Blue</SelectItem>
                                            <SelectItem Value="@((LedColor?)null)">Off</SelectItem>
                                        </Select>
                                        <FieldHelp>LED color that flashes every 5 seconds during idle</FieldHelp>
                                    </Field>
                                </Validation>
                            </Validations>
                        </Column>
                        <Column ColumnSize="ColumnSize.Is6.OnTablet">
                            <Card Background="Background.Light">
                                <CardBody>
                                    <Heading Size="HeadingSize.Is6">Idle State Preview</Heading>
                                    <Div Flex="Flex.JustifyContent.Start.AlignItems.Center" Margin="Margin.Is2.FromBottom">
                                        <Badge Color="@GetFeedbackBadgeColor(_idleForm.PermanentLedColor)" Margin="Margin.Is2.FromEnd">
                                            Permanent: @(_idleForm.PermanentLedColor?.ToString() ?? "Off")
                                        </Badge>
                                        <Badge Color="@GetFeedbackBadgeColor(_idleForm.HeartbeatFlashColor)" Margin="Margin.Is2.FromEnd">
                                            Heartbeat: @(_idleForm.HeartbeatFlashColor?.ToString() ?? "Off")
                                        </Badge>
                                        <Badge Color="Color.Dark">Every 5 sec</Badge>
                                    </Div>
                                    <Alert Color="Color.Info" Visible="true">
                                        <AlertMessage>
                                            These settings apply when the reader is idle (no card activity).
                                        </AlertMessage>
                                    </Alert>
                                </CardBody>
                            </Card>
                        </Column>
                    </Row>
                </CardBody>
            </Card>
        </Column>
    </Row>

    <Row Margin="Margin.Is4.FromTop">
        <Column>
            <Card>
                <CardHeader>
                    <CardTitle Size="6" Margin="Margin.Is0.FromBottom">Feedback Preview</CardTitle>
                </CardHeader>
                <CardBody>
                    <Row>
                        <Column ColumnSize="ColumnSize.Is6.OnTablet">
                            <Heading Size="HeadingSize.Is6">Success Pattern</Heading>
                            <Div Flex="Flex.JustifyContent.Start.AlignItems.Center" Margin="Margin.Is2.FromBottom">
                                <Badge Color="@GetFeedbackBadgeColor(_successForm.LedColor)" Margin="Margin.Is2.FromEnd">
                                    @_successForm.LedColor
                                </Badge>
                                <Badge Color="Color.Secondary" Margin="Margin.Is2.FromEnd">@_successForm.BeepCount beeps</Badge>
                                <Badge Color="Color.Info">@_successForm.LedDurationSeconds sec</Badge>
                            </Div>
                            <Div Border="Border.Is1" Padding="Padding.Is2" Background="Background.Light">
                                <Small TextColor="TextColor.Dark" Style="font-family: monospace;">@_successForm.DisplayMessage</Small>
                            </Div>
                        </Column>
                        <Column ColumnSize="ColumnSize.Is6.OnTablet">
                            <Heading Size="HeadingSize.Is6">Failure Pattern</Heading>
                            <Div Flex="Flex.JustifyContent.Start.AlignItems.Center" Margin="Margin.Is2.FromBottom">
                                <Badge Color="@GetFeedbackBadgeColor(_failureForm.LedColor)" Margin="Margin.Is2.FromEnd">
                                    @_failureForm.LedColor
                                </Badge>
                                <Badge Color="Color.Secondary" Margin="Margin.Is2.FromEnd">@_failureForm.BeepCount beeps</Badge>
                                <Badge Color="Color.Info">@_failureForm.LedDurationSeconds sec</Badge>
                            </Div>
                            <Div Border="Border.Is1" Padding="Padding.Is2" Background="Background.Light">
                                <Small TextColor="TextColor.Dark" Style="font-family: monospace;">@_failureForm.DisplayMessage</Small>
                            </Div>
                        </Column>
                    </Row>
                </CardBody>
            </Card>
        </Column>
    </Row>

    <Row Margin="Margin.Is4.FromTop">
        <Column>
            <Button Color="Color.Primary" Clicked="SaveDefaultFeedback" Loading="_saving" ElementId="save-feedback-button" Disabled="_saving">
                <Icon Name="IconName.Check" Margin="Margin.Is2.FromEnd" />Save Default Feedback Settings
            </Button>
        </Column>
    </Row>
</Container>

<Snackbar @ref="_snackbar">
    <SnackbarBody>
        @_snackbarMessage
    </SnackbarBody>
</Snackbar>

@code {
    [Parameter] public EventCallback<string> OnShowMessage { get; set; }
    
    private bool _saving = false;
    
    // Validation references
    private Validations? _successValidations;
    private Validations? _failureValidations;
    private Validations? _idleValidations;
    
    // Snackbar
    private Snackbar? _snackbar;
    private string? _snackbarMessage;
    
    // Form models
    private FeedbackFormModel _successForm = new()
    {
        LedColor = LedColor.Green,
        BeepCount = 1,
        LedDurationSeconds = 1,
        DisplayMessage = "ACCESS GRANTED"
    };
    
    private FeedbackFormModel _failureForm = new()
    {
        LedColor = LedColor.Red,
        BeepCount = 3,
        LedDurationSeconds = 2,
        DisplayMessage = "ACCESS DENIED"
    };
    
    private IdleStateFormModel _idleForm = new()
    {
        PermanentLedColor = LedColor.Blue,
        HeartbeatFlashColor = LedColor.Green
    };

    private async Task SaveDefaultFeedback()
    {
        // Validate all forms
        var successValid = _successValidations == null || await _successValidations.ValidateAll();
        var failureValid = _failureValidations == null || await _failureValidations.ValidateAll();
        var idleValid = _idleValidations == null || await _idleValidations.ValidateAll();
        
        if (!successValid || !failureValid || !idleValid)
        {
            await ShowSnackbar("Please correct the validation errors", SnackbarColor.Danger);
            return;
        }
        
        _saving = true;
        StateHasChanged();
        
        try
        {
            // TODO: Save to configuration service when available
            await Task.Delay(1000); // Simulate save operation
            await ShowSnackbar("Default feedback settings saved successfully", SnackbarColor.Success);
        }
        catch (Exception ex)
        {
            await ShowSnackbar($"Error saving feedback settings: {ex.Message}", SnackbarColor.Danger);
        }
        finally
        {
            _saving = false;
            StateHasChanged();
        }
    }

    private async Task ShowSnackbar(string message, SnackbarColor color)
    {
        if (_snackbar != null)
        {
            _snackbar.Color = color;
            _snackbarMessage = message;
            await _snackbar.Show();
        }
    }

    private Color GetFeedbackBadgeColor(LedColor? color)
    {
        return color switch
        {
            LedColor.Red => Color.Danger,
            LedColor.Green => Color.Success,
            LedColor.Amber => Color.Warning,
            LedColor.Blue => Color.Primary,
            _ => Color.Secondary
        };
    }

    // Form model for feedback data binding
    public class FeedbackFormModel
    {
        [Required(ErrorMessage = "LED Color is required")]
        public LedColor LedColor { get; set; }
        
        [Required(ErrorMessage = "Beep count is required")]
        [Range(0, 10, ErrorMessage = "Beep count must be between 0 and 10")]
        public int BeepCount { get; set; }
        
        [Required(ErrorMessage = "LED duration is required")]
        [Range(1, 10, ErrorMessage = "LED duration must be between 1 and 10 seconds")]
        public int LedDurationSeconds { get; set; }
        
        [StringLength(16, ErrorMessage = "Display message cannot exceed 16 characters")]
        public string DisplayMessage { get; set; } = string.Empty;

        public ReaderFeedback ToReaderFeedback(ReaderFeedbackType type)
        {
            return new ReaderFeedback
            {
                Type = type,
                LedColor = LedColor,
                BeepCount = BeepCount,
                LedDurationMs = LedDurationSeconds * 1000, // Convert seconds to milliseconds
                DisplayMessage = DisplayMessage
            };
        }
    }

    // Form model for idle state LED configuration
    public class IdleStateFormModel
    {
        public LedColor? PermanentLedColor { get; set; }
        
        public LedColor? HeartbeatFlashColor { get; set; }
    }
}