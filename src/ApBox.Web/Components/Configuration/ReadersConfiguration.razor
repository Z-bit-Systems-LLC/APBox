@using ApBox.Core.Services
@using ApBox.Plugins
@inject IReaderConfigurationService ReaderConfigurationService

<Container Fluid>
    <Row Margin="Margin.Is3.FromBottom">
        <Column>
            <Row JustifyContent="JustifyContent.Between" AlignItems="AlignItems.Center">
                <Column ColumnSize="ColumnSize.IsAuto">
                    <Heading Size="HeadingSize.Is3" ElementId="readers-title">Reader Configuration</Heading>
                </Column>
                <Column ColumnSize="ColumnSize.IsAuto">
                    <Button Color="Color.Primary" Clicked="ShowAddReaderModal" ElementId="add-reader-button">
                        <Icon Name="IconName.Add" Margin="Margin.Is2.FromEnd" />
                        Add Reader
                    </Button>
                </Column>
            </Row>
        </Column>
    </Row>
    @if (_readers.Any())
    {
        <Row>
            @foreach (var reader in _readers)
            {
                <Column ColumnSize="ColumnSize.Is6.OnTablet.Is4.OnDesktop" Margin="Margin.Is4.FromBottom">
                    <Card Height="Height.Is100">
                        <CardHeader>
                            <Row JustifyContent="JustifyContent.Between" AlignItems="AlignItems.Center">
                                <Column ColumnSize="ColumnSize.IsAuto">
                                    <CardTitle Margin="Margin.Is0.FromBottom">@reader.ReaderName</CardTitle>
                                </Column>
                                <Column ColumnSize="ColumnSize.IsAuto">
                                    <Buttons Size="Size.Small">
                                        <Button Color="Color.Primary" Outline Clicked="() => EditReader(reader)" ElementId="@($"edit-reader-{reader.ReaderId}")">
                                            <Icon Name="IconName.Edit" />
                                        </Button>
                                        <Button Color="Color.Danger" Outline Clicked="() => DeleteReader(reader)" ElementId="@($"delete-reader-{reader.ReaderId}")">
                                            <Icon Name="IconName.Delete" />
                                        </Button>
                                    </Buttons>
                                </Column>
                            </Row>
                        </CardHeader>
                        <CardBody>
                            <Paragraph TextColor="TextColor.Muted" Margin="Margin.Is2.FromBottom">
                                <Small>Reader ID: @reader.ReaderId.ToString()[..8]...</Small>
                            </Paragraph>
                            <Badge Color="Color.Info" Margin="Margin.Is2.FromBottom">
                                @reader.ReaderId.ToString()[..8]...
                            </Badge>
                        </CardBody>
                    </Card>
                </Column>
            }
        </Row>
    }
    else
    {
        <Row JustifyContent="JustifyContent.Center" TextAlignment="TextAlignment.Center" Padding="Padding.Is5.OnY">
            <Column ColumnSize="ColumnSize.IsAuto">
                <Icon Name="IconName.Tv" IconSize="IconSize.x5" TextColor="TextColor.Muted" Margin="Margin.Is3.FromBottom" />
                <Heading Size="HeadingSize.Is4" Margin="Margin.Is3.FromTop">No Readers Configured</Heading>
                <Paragraph TextColor="TextColor.Muted" Margin="Margin.Is3.FromBottom">Use the "Add Reader" button above to get started</Paragraph>
            </Column>
        </Row>
    }
</Container>

<!-- Add/Edit Reader Modal -->
<Modal @ref="_readerModal" ElementId="reader-modal">
    <ModalContent Size="ModalSize.Large">
        <ModalHeader>
            <ModalTitle>@(_editingReader != null ? "Edit Reader" : "Add Reader")</ModalTitle>
            <CloseButton />
        </ModalHeader>
        <ModalBody>
            <Field>
                <FieldLabel>Reader Name</FieldLabel>
                <TextEdit @bind-Text="_readerForm.ReaderName" Placeholder="e.g., Main Entrance" ElementId="reader-name-input" />
                <FieldHelp>Enter a descriptive name for this reader</FieldHelp>
            </Field>
        </ModalBody>
        <ModalFooter>
            <Button Color="Color.Secondary" Clicked="CloseReaderModal">Cancel</Button>
            <Button Color="Color.Primary" Clicked="SaveReader" Loading="_saving" ElementId="save-reader-button">
                Save Reader
            </Button>
        </ModalFooter>
    </ModalContent>
</Modal>

<!-- Delete Confirmation Modal -->
<Modal @ref="_deleteModal" ElementId="delete-modal">
    <ModalContent>
        <ModalHeader>
            <ModalTitle>Confirm Deletion</ModalTitle>
            <CloseButton />
        </ModalHeader>
        <ModalBody>
            <Paragraph>Are you sure you want to delete the reader <Strong>@_readerToDelete?.ReaderName</Strong>?</Paragraph>
            <Paragraph TextColor="TextColor.Muted">This action cannot be undone.</Paragraph>
        </ModalBody>
        <ModalFooter>
            <Button Color="Color.Secondary" Clicked="CloseDeleteModal">Cancel</Button>
            <Button Color="Color.Danger" Clicked="ConfirmDeleteReader" Loading="_deleting" ElementId="confirm-delete-button">
                Delete Reader
            </Button>
        </ModalFooter>
    </ModalContent>
</Modal>

@code {
    [Parameter] public EventCallback<string> OnShowMessage { get; set; }
    
    private List<ReaderConfiguration> _readers = new();
    
    // Modal references
    private Modal? _readerModal;
    private Modal? _deleteModal;
    private bool _saving;
    private bool _deleting;
    
    // Form data
    private ReaderFormModel _readerForm = new();
    private ReaderConfiguration? _editingReader;
    private ReaderConfiguration? _readerToDelete;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        try
        {
            _readers = (await ReaderConfigurationService.GetAllReadersAsync()).ToList();
        }
        catch (Exception ex)
        {
            await OnShowMessage.InvokeAsync($"Error loading readers: {ex.Message}|danger");
        }
    }

    private async Task ShowAddReaderModal()
    {
        _editingReader = null;
        _readerForm = new ReaderFormModel();
        await _readerModal!.Show();
    }

    private async Task EditReader(ReaderConfiguration reader)
    {
        _editingReader = reader;
        _readerForm = ReaderFormModel.FromReaderConfiguration(reader);
        await _readerModal!.Show();
    }

    private async Task DeleteReader(ReaderConfiguration reader)
    {
        _readerToDelete = reader;
        await _deleteModal!.Show();
    }
    
    private async Task CloseReaderModal()
    {
        _editingReader = null;
        _readerForm = new ReaderFormModel();
        await _readerModal!.Hide();
    }
    
    private async Task CloseDeleteModal()
    {
        _readerToDelete = null;
        await _deleteModal!.Hide();
    }
    
    private async Task SaveReader()
    {
        if (string.IsNullOrWhiteSpace(_readerForm.ReaderName))
        {
            await OnShowMessage.InvokeAsync("Reader name is required|danger");
            return;
        }
        
        _saving = true;
        StateHasChanged();
        
        try
        {
            var readerConfig = _readerForm.ToReaderConfiguration();
            
            // Auto-generate GUID for new readers
            readerConfig.ReaderId = _editingReader?.ReaderId ?? Guid.NewGuid();
            
            // Save reader (handles both create and update)
            await ReaderConfigurationService.SaveReaderAsync(readerConfig);
            
            if (_editingReader != null)
            {
                await OnShowMessage.InvokeAsync($"Reader '{readerConfig.ReaderName}' updated successfully|success");
            }
            else
            {
                await OnShowMessage.InvokeAsync($"Reader '{readerConfig.ReaderName}' created successfully|success");
            }
            
            await CloseReaderModal();
            await LoadData();
        }
        catch (Exception ex)
        {
            await OnShowMessage.InvokeAsync($"Error saving reader: {ex.Message}|danger");
        }
        finally
        {
            _saving = false;
            StateHasChanged();
        }
    }
    
    private async Task ConfirmDeleteReader()
    {
        if (_readerToDelete == null) return;
        
        _deleting = true;
        StateHasChanged();
        
        try
        {
            await ReaderConfigurationService.DeleteReaderAsync(_readerToDelete.ReaderId);
            await OnShowMessage.InvokeAsync($"Reader '{_readerToDelete.ReaderName}' deleted successfully|success");
            
            await CloseDeleteModal();
            await LoadData();
        }
        catch (Exception ex)
        {
            await OnShowMessage.InvokeAsync($"Error deleting reader: {ex.Message}|danger");
        }
        finally
        {
            _deleting = false;
            StateHasChanged();
        }
    }

    // Form model for reader data binding
    public class ReaderFormModel
    {
        public string ReaderName { get; set; } = string.Empty;

        public static ReaderFormModel FromReaderConfiguration(ReaderConfiguration reader)
        {
            return new ReaderFormModel
            {
                ReaderName = reader.ReaderName
            };
        }

        public ReaderConfiguration ToReaderConfiguration()
        {
            return new ReaderConfiguration
            {
                ReaderId = Guid.Empty, // Will be set in SaveReader method
                ReaderName = ReaderName
            };
        }
    }
}