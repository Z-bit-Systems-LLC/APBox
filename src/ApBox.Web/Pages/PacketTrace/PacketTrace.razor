@page "/packet-trace"
@using ApBox.Core.PacketTracing.Models
@using ApBox.Web.ViewModels
@using OSDP.Net.Tracing
@using Blazorise.SpinKit
@inject PacketTraceViewModel ViewModel
@implements IDisposable

<PageTitle>Packet Trace</PageTitle>

<Container Fluid ElementId="packet-trace-container">
    <Row Margin="Margin.Is4.FromBottom">
        <Column>
            <Heading Size="HeadingSize.Is1" ElementId="packet-trace-title">Packet Trace</Heading>
            <Paragraph TextColor="TextColor.Muted" ElementId="packet-trace-subtitle">Capture and analyze OSDP protocol packets</Paragraph>
        </Column>
    </Row>

    @if (ViewModel.IsLoading)
    {
        <Row ElementId="loading-spinner">
            <Column>
                <Div Display="Display.Flex" JustifyContent="JustifyContent.Center" Margin="Margin.Is5.FromTop">
                    <Text Margin="Margin.Is2.FromEnd">Loading packet trace...</Text>
                    <SpinKit Type="SpinKitType.Pulse"/>
                </Div>
            </Column>
        </Row>
    }
    else if (!string.IsNullOrEmpty(ViewModel.ErrorMessage))
    {
        <Row>
            <Column>
                <Alert Color="Color.Danger" Visible="true">
                    <Icon Name="IconName.ExclamationTriangle" Margin="Margin.Is2.FromEnd" />
                    @ViewModel.ErrorMessage
                    <Button Color="Color.Secondary" Size="Size.Small" Margin="Margin.Is2.FromStart" Clicked="ViewModel.InitializeCommand.ExecuteAsync">
                        <Icon Name="IconName.Redo" />
                        Retry
                    </Button>
                </Alert>
            </Column>
        </Row>
    }
    else
    {
        <Row>
            <Column ColumnSize="ColumnSize.Is3.OnDesktop.Is12.OnMobile">
                <!-- Settings Panel -->
                <Card ElementId="trace-settings-card">
                    <CardHeader>
                        <CardTitle>
                            <Icon Name="IconName.Settings" Margin="Margin.Is2.FromEnd" />
                            Trace Settings
                        </CardTitle>
                    </CardHeader>
                <CardBody>
                    <!-- Filters -->
                    <Field>
                        <FieldLabel>Display Filters</FieldLabel>
                        <Check Checked="@ViewModel.FilterPollCommands" CheckedChanged="@(async (bool value) => await OnPollFilterChanged(value))">
                            Hide Poll Commands
                        </Check>
                        <Check Checked="@ViewModel.FilterAckCommands" CheckedChanged="@(async (bool value) => await OnAckFilterChanged(value))">
                            Hide ACK Replies
                        </Check>
                    </Field>
                    
                </CardBody>
            </Card>
            
                <!-- Statistics Card -->
                <Card Margin="Margin.Is3.FromTop" ElementId="trace-statistics-card">
                    <CardHeader>
                        <CardTitle>
                            <Icon Name="IconName.ChartLine" Margin="Margin.Is2.FromEnd" />
                            Statistics
                        </CardTitle>
                    </CardHeader>
                <CardBody>
                    <Field>
                        <FieldLabel>Reply Rate</FieldLabel>
                        <Text>@ViewModel.ReplyPercentage.ToString("F1")%</Text>
                    </Field>
                    <Field Margin="Margin.Is3.FromTop">
                        <FieldLabel>Average Response Time</FieldLabel>
                        <Text>
                            @if (ViewModel.AverageResponseTimeMs > 0)
                            {
                                @($"{ViewModel.AverageResponseTimeMs:F1} ms")
                            }
                            else
                            {
                                <span>N/A</span>
                            }
                        </Text>
                    </Field>
                </CardBody>
            </Card>
            </Column>
            
            <Column ColumnSize="ColumnSize.Is9.OnDesktop.Is12.OnMobile">
                <!-- Packet Trace Grid -->
                <Card ElementId="packet-traces-card">
                    <CardHeader>
                    <Div Flex="Flex.JustifyContent.Between" Width="Width.Is100">
                        <Buttons>
                            <Button Color="Color.Success"
                                    Clicked="@StartTracing"
                                    Disabled="@ViewModel.TracingEnabled"
                                    Size="Size.Small">
                                <Icon Name="IconName.Play" /> Start
                            </Button>
                            <Button Color="Color.Danger"
                                    Clicked="@StopTracing"
                                    Disabled="@(!ViewModel.TracingEnabled)"
                                    Size="Size.Small">
                                <Icon Name="IconName.Stop" /> Stop
                            </Button>
                        </Buttons>
                        <Dropdown Direction="Direction.Down">
                            <DropdownToggle Color="Color.Secondary" Size="Size.Small" Disabled="@(!ViewModel.Packets.Any())">
                                <Icon Name="IconName.Download" /> Export
                            </DropdownToggle>
                            <DropdownMenu>
                                <DropdownItem Clicked="@ExportBothFormats">
                                    <Icon Name="IconName.FileDownload" Margin="Margin.Is2.FromEnd" />
                                    Export Both Formats
                                </DropdownItem>
                                <DropdownDivider />
                                <DropdownItem Clicked="@ExportToOsdpCapture">
                                    <Icon Name="IconName.File" Margin="Margin.Is2.FromEnd" />
                                    OSDP Capture (.osdpcap)
                                </DropdownItem>
                                <DropdownItem Clicked="@ExportToParsedJson">
                                    <Icon Name="IconName.FileAlt" Margin="Margin.Is2.FromEnd" />
                                    Parsed Packets (.txt)
                                </DropdownItem>
                            </DropdownMenu>
                        </Dropdown>
                    </Div>
                </CardHeader>
                    <CardBody>
                        @if (GetFilteredPackets().Any())
                        {
                            <Table Striped Hoverable Responsive ElementId="packet-traces-table">
                                <TableHeader>
                                    <TableRow>
                                        <TableHeaderCell>Time</TableHeaderCell>
                                        <TableHeaderCell>Î”t</TableHeaderCell>
                                        <TableHeaderCell>Direction</TableHeaderCell>
                                        <TableHeaderCell>Address</TableHeaderCell>
                                        <TableHeaderCell>Type</TableHeaderCell>
                                        <TableHeaderCell>Secure</TableHeaderCell>
                                    </TableRow>
                                </TableHeader>
                            <TableBody>
                                @foreach (var packet in GetFilteredPackets().Take(50))
                                {
                                    <TableRow Clicked="@(() => ShowPacketDetails(packet))" Style="cursor: pointer;">
                                        <TableRowCell>
                                            <small>@packet.LocalTimestamp.ToString("HH:mm:ss.fff")</small>
                                        </TableRowCell>
                                        <TableRowCell>
                                            @if (packet.Interval.TotalMilliseconds > 0)
                                            {
                                                <small class="text-muted">+@packet.Interval.TotalMilliseconds.ToString("F0")ms</small>
                                            }
                                        </TableRowCell>
                                        <TableRowCell>
                                            <Badge Color="@(packet.Direction == TraceDirection.Output ? Color.Primary : Color.Success)">
                                                @if (packet.Direction == TraceDirection.Output)
                                                {
                                                    <Icon Name="IconName.ArrowRight" Margin="Margin.Is1.FromEnd" />
                                                    <span>OUT</span>
                                                }
                                                else
                                                {
                                                    <Icon Name="IconName.ArrowLeft" Margin="Margin.Is1.FromEnd" />
                                                    <span>IN</span>
                                                }
                                            </Badge>
                                        </TableRowCell>
                                        <TableRowCell>
                                            <span>@packet.Packet.Address</span>
                                        </TableRowCell>
                                        <TableRowCell>
                                            <span>@packet.Type</span>
                                        </TableRowCell>
                                        <TableRowCell>
                                            @switch (packet.SecurityState)
                                            {
                                                case PacketSecurityState.ClearText:
                                                    <Badge Color="Color.Danger">Clear Text</Badge>
                                                    break;
                                                case PacketSecurityState.SecureDefaultKey:
                                                    <Badge Color="Color.Warning">Default Key</Badge>
                                                    break;
                                                case PacketSecurityState.Secure:
                                                    <Badge Color="Color.Success">Secure</Badge>
                                                    break;
                                            }
                                        </TableRowCell>
                                    </TableRow>
                                }
                            </TableBody>
                        </Table>
                        }
                        else
                        {
                            <Div TextAlignment="TextAlignment.Center" Padding="Padding.Is5" ElementId="no-packets-message">
                                <Icon Name="IconName.List" IconSize="IconSize.x3" TextColor="TextColor.Muted" />
                                <Heading Size="HeadingSize.Is4" Margin="Margin.Is3.FromTop">No Packets to Display</Heading>
                                <Paragraph TextColor="TextColor.Muted">
                                    @if (ViewModel.TracingEnabled)
                                    {
                                        <span>No packets match the current display filters, or no packets have been captured yet.</span>
                                    }
                                    else
                                    {
                                        <span>Start tracing to capture OSDP packets from configured readers.</span>
                                    }
                                </Paragraph>
                            </Div>
                        }
                </CardBody>
            </Card>
            </Column>
        </Row>
    }
</Container>

<Modal @ref="_detailsModal" ElementId="packet-details-modal">
    <ModalContent Centered Size="ModalSize.Large">
        <ModalHeader>
            <ModalTitle>
                @if (_selectedPacket != null)
                {
                    <Badge Color="@(_selectedPacket.Direction == TraceDirection.Output ? Color.Primary : Color.Success)" Margin="Margin.Is2.FromEnd">
                        @(_selectedPacket.Direction == TraceDirection.Output ? "OUT" : "IN")
                    </Badge>
                    <Text>@_selectedPacket.Type</Text>
                }
                else
                {
                    <Text>Packet Details</Text>
                }
            </ModalTitle>
            <CloseButton />
        </ModalHeader>
        <ModalBody>
            @if (_selectedPacket != null)
            {
                <Row Margin="Margin.Is3.FromBottom">
                    <Column ColumnSize="ColumnSize.Is4">
                        <Small TextColor="TextColor.Muted">Time</Small>
                        <Div>@_selectedPacket.LocalTimestamp.ToString("HH:mm:ss.fff")</Div>
                    </Column>
                    <Column ColumnSize="ColumnSize.Is4">
                        <Small TextColor="TextColor.Muted">Address</Small>
                        <Div>@_selectedPacket.Packet.Address</Div>
                    </Column>
                    <Column ColumnSize="ColumnSize.Is4">
                        <Small TextColor="TextColor.Muted">Security</Small>
                        <Div>
                            @switch (_selectedPacket.SecurityState)
                            {
                                case PacketSecurityState.ClearText:
                                    <Badge Color="Color.Danger">Clear Text</Badge>
                                    break;
                                case PacketSecurityState.SecureDefaultKey:
                                    <Badge Color="Color.Warning">Default Key</Badge>
                                    break;
                                case PacketSecurityState.Secure:
                                    <Badge Color="Color.Success">Secure</Badge>
                                    break;
                            }
                        </Div>
                    </Column>
                </Row>
                <Divider />
                <Small TextColor="TextColor.Muted">Payload</Small>
                <Div Background="Background.Light" Padding="Padding.Is3" Margin="Margin.Is2.FromTop" Style="white-space: pre-wrap; font-family: monospace; overflow-x: auto; max-height: 400px; overflow-y: auto;">@FormatDetails(_selectedPacket.Details)</Div>
            }
        </ModalBody>
        <ModalFooter>
            <Button Color="Color.Secondary" Clicked="@HidePacketDetails">Close</Button>
        </ModalFooter>
    </ModalContent>
</Modal>

@code {
    private Modal? _detailsModal;
    private PacketTraceEntry? _selectedPacket;
    protected override async Task OnInitializedAsync()
    {
        // Set up component callbacks for the ViewModel
        ViewModel.StateHasChanged = StateHasChanged;
        ViewModel.InvokeAsync = InvokeAsync;
        
        await ViewModel.InitializeCommand.ExecuteAsync(null);
    }
    
    private IEnumerable<PacketTraceEntry> GetFilteredPackets()
    {
        return ViewModel.Packets.Where(packet => 
        {
            if (ViewModel.FilterPollCommands && IsPollCommand(packet.Type)) return false;
            if (ViewModel.FilterAckCommands && IsAckReply(packet.Type)) return false;
            return true;
        });
    }
    
    private static bool IsPollCommand(string packetType)
    {
        return packetType.Contains("Poll", StringComparison.OrdinalIgnoreCase);
    }
    
    private static bool IsAckReply(string packetType)
    {
        return packetType.Contains("Ack", StringComparison.OrdinalIgnoreCase);
    }
    
    
    private async Task StartTracing()
    {
        await ViewModel.StartTracingCommand.ExecuteAsync(null);
    }
    
    private void StopTracing()
    {
        ViewModel.StopTracingCommand.Execute(null);
    }
    
    
    private async Task ExportToOsdpCapture()
    {
        await ViewModel.ExportToOsdpCaptureCommand.ExecuteAsync(null);
    }

    private async Task ExportToParsedJson()
    {
        await ViewModel.ExportToParsedJsonCommand.ExecuteAsync(null);
    }

    private async Task ExportBothFormats()
    {
        await ViewModel.ExportBothFormatsCommand.ExecuteAsync(null);
    }
    

    private async Task OnPollFilterChanged(bool value)
    {
        ViewModel.FilterPollCommands = value;
        // Auto-refresh is handled by the ViewModel's OnFilterPollCommandsChanged method
        await ViewModel.ApplySettingsCommand.ExecuteAsync(null);
    }
    
    private async Task OnAckFilterChanged(bool value)
    {
        ViewModel.FilterAckCommands = value;
        // Auto-refresh is handled by the ViewModel's OnFilterAckCommandsChanged method
        await ViewModel.ApplySettingsCommand.ExecuteAsync(null);
    }

    private async Task ShowPacketDetails(PacketTraceEntry packet)
    {
        _selectedPacket = packet;
        if (_detailsModal != null)
        {
            await _detailsModal.Show();
        }
    }

    private async Task HidePacketDetails()
    {
        if (_detailsModal != null)
        {
            await _detailsModal.Hide();
        }
        _selectedPacket = null;
    }

    private static string FormatDetails(string details)
    {
        return string.IsNullOrEmpty(details) ? "Empty" : details;
    }

    public void Dispose()
    {
        // Dispose the ViewModel to clean up subscriptions
        ViewModel.Dispose();
    }
}

<script>
    window.downloadFile = function(dataUri, fileName) {
        const link = document.createElement('a');
        link.href = dataUri;
        link.download = fileName;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    };
</script>